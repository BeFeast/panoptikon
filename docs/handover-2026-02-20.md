# Panoptikon — Handover 2026-02-20

Session: 2026-02-19 22:00 → 2026-02-20 00:40 (GMT+2)

---

## State of the project

### Server
- **Running:** `systemctl --user status panoptikon` on `10.10.0.14:8080`
- **Binary:** `target/release/panoptikon-server` (release build)
- **Config:** `/home/shtrudel/src/panoptikon/panoptikon.toml` (VyOS URL still placeholder)
- **DB:** `/home/shtrudel/src/panoptikon/panoptikon.db`
- **Log:** `/tmp/panoptikon.log`

### Auth
- **Password:** `panoptikon` (was reset via sqlite3 — Oleg should change via Settings page)
- Sessions are in-memory, cleared on restart

### Latest commit
```
04c0b7c  docs: add PRD
0c240b7  test(e2e): Playwright suite for agents page + fix autoFocus on delete
d9efd9f  fix(ui): min-w-0 on dialog grid-item prevents pre intrinsic-width expansion
1070cac  feat(dev): next.config dev-proxy to Rust backend for hot-reload
755fbbf  fix(ui): CopyBlock header-bar layout + fix dialog width
ec2633f  fix(ci): cargo fmt + @radix-ui/react-alert-dialog to package.json
a13b13a  fix(ui): replace confirm/alert with AlertDialog, fix CopyBlock layout
6296a8b  fix(api): restore colon-style path params for axum routing
```

CI: **green** ✅

---

## What was done today

### 1. Fixed DELETE/PATCH 405 Method Not Allowed
**Root cause:** Axum 0.7 dynamic path params `{id}` (curly-brace style) silently break
route matching when the router is nested + merged with a layered sub-router.

**Fix:**
- `mod.rs` — switched all path params to colon style (`:id`, `:platform`)
- Separated chained `get(f).patch(f2).delete(f3)` into individual `.route()` calls
- Replaced `.layer()` with `.route_layer()` on protected routes

### 2. Fixed CopyBlock overflowing out of dialog
**Root cause (two-part):**

1. `w-[min(90vw,680px)]` — Tailwind JIT doesn't parse commas inside `[]`,
   class was silently ignored, dialog fell back to shadcn default width (~512px)
   → Fixed: `w-full max-w-[680px]`

2. `<pre white-space:pre>` inside CSS grid has large min-content intrinsic width.
   Radix `DialogContent` uses `display: grid`. The `auto` track sizes to the
   largest min-content item, expanding the track to 832px despite 680px container.
   → Fixed: `min-w-0` on the direct grid child (space-y-4 div)

**Layout history (what didn't work and why):**
- `absolute right-2 top-2` button → clipped by `overflow-hidden` on dialog
- `flex` sibling button → pre's intrinsic width still expanded the flex container
- `overflow-hidden` on CopyBlock outer div → clips visual overflow but doesn't
  constrain the element's own width, grid track still expanded
- **Header-bar layout** (button in separate row above pre) + `min-w-0` → **works**

### 3. Replaced browser native dialogs with shadcn
- `confirm()` on delete → `AlertDialog` with Cancel/Delete buttons
- `alert()` on rename error → inline `<p className="text-red-400">`
- Rule written to `AGENTS.md`

### 4. Fixed Enter key on delete dialog
Radix AlertDialog auto-focuses **Cancel** by default (safe UX pattern).
Enter was triggering Cancel, not Delete. Fixed with `autoFocus` on `AlertDialogAction`.

### 5. Added change-password endpoint + Settings UI
- `POST /api/v1/auth/change-password` — verifies current pw, updates hash, clears all sessions
- Full Settings page with password form, strength indicator, eye toggle, inline errors

### 6. Fixed agent install script (non-root macOS/Linux)
- Was trying `mkdir /etc/panoptikon-agent` without root → Permission denied
- Now detects `id -u`: root → system paths, user → `~/.local/bin` + `~/.config/panoptikon-agent`
- Agent binary: `--config` is optional, auto-discovers user config path

### 7. Established visual testing workflow
**Key insight:** headless screenshots + human visual review = unreliable.
Use `getBoundingClientRect()` assertions instead.

**Setup:**
- Playwright installed: `@playwright/test@1.58.2` + Chromium
- Config: `web/playwright.config.ts`
- Tests: `web/e2e/agents.spec.ts` (7 tests, all green)
- Dev server: `next.config.ts` has conditional proxy → `bun run dev --port 3001`

**How to run tests:**
```bash
cd /home/shtrudel/src/panoptikon/web
~/.bun/bin/bunx playwright test
# HTML report:
~/.bun/bin/bunx playwright show-report
```

---

## DB cleanup needed

Test agents accumulated during session — delete before real use:
```bash
sqlite3 /home/shtrudel/src/panoptikon/panoptikon.db \
  "DELETE FROM agents WHERE name LIKE 'e2e-%' OR name IN ('fixtest','sdf','dimtest');"
```

---

## What's left (priority order)

### P0 — Polish / near-complete
- [ ] **Dashboard StatCard links** — add `href` props to 4 cards in `dashboard/page.tsx`:
  - Router Status → `/router`
  - Active Devices → `/devices`
  - WAN Bandwidth → `/traffic`
  - Unread Alerts → `/alerts`
  - `StatCard` component already supports `href` prop

- [ ] **Change password** — Oleg should set a real password via Settings
  (current: `panoptikon`, set via DB bypass)

### P0 — Mac Mini agent
- Repo is public → `git clone` works
- Rust must be installed: `curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh`
- Run install script from Add Agent dialog (darwin-amd64 tab)
- API key from previous attempt: `pnk_e128cd616b394c278db90823a164eec5`
  (check if still valid — may have been deleted)

### P1 — VyOS connection
Edit `/home/shtrudel/src/panoptikon/panoptikon.toml`:
```toml
[vyos]
url = "https://192.168.x.x"  # real VyOS IP
api_key = "your-key"
```
Server restart needed after config change.

### P1 — E2E tests: expand coverage
Current tests only cover Agents page. Add:
- `dashboard.spec.ts` — stat cards, links work
- `devices.spec.ts` — device list, no overflow
- `settings.spec.ts` — change password flow
- `auth.spec.ts` — login, logout, redirect

### P2 — GitHub Release CI pipeline
Pre-built agent binaries for linux-amd64/arm64, darwin-amd64/arm64.
Install script already checks for releases before falling back to source build.
Add `.github/workflows/release.yml` with cross-compilation via `cross` crate.

### P2 — OUI database
Replace 20-vendor stub in `server/src/oui.rs` with full IEEE MA-L CSV.
Download: `https://standards-oui.ieee.org/oui/oui.csv`
Embed at build time with `include_str!()` or build script.

### P3 — VyOS read-only views
Routes exist in server. UI stub pages need implementation:
- Router: interfaces, routing table
- Traffic: WAN bandwidth (requires iperf3 or flow data)
- Firewall rules viewer

---

## Architecture reference

```
/home/shtrudel/src/panoptikon/
├── server/src/
│   ├── api/
│   │   ├── mod.rs          ← router, AppState, all routes registered here
│   │   ├── agents.rs       ← CRUD + WebSocket + install script
│   │   ├── auth.rs         ← login/logout/change-password + middleware
│   │   ├── dashboard.rs    ← stats, top devices
│   │   ├── devices.rs      ← ARP-discovered devices
│   │   └── vyos.rs         ← proxy to VyOS HTTP API
│   ├── db/
│   │   ├── mod.rs          ← init, run_migrations
│   │   └── migrations/001_init.sql
│   ├── ws/hub.rs           ← WebSocket broadcast hub
│   └── main.rs
├── agent/src/main.rs       ← standalone binary, WebSocket to server
├── web/
│   ├── src/app/(app)/      ← authenticated pages
│   ├── e2e/                ← Playwright tests
│   ├── playwright.config.ts
│   └── next.config.ts      ← dev: proxy to :8080, prod: static export
├── docs/
│   ├── PRD.md
│   └── handover-2026-02-20.md  ← this file
└── panoptikon.toml         ← server config (VyOS URL placeholder)
```

## Key commands

```bash
# Build server
cd /home/shtrudel/src/panoptikon
~/.cargo/bin/cargo build --release --bin panoptikon-server

# Restart service
systemctl --user restart panoptikon

# Build frontend
cd web && ~/.bun/bin/bun run build

# Dev frontend (hot-reload, proxy to :8080)
cd web && ~/.bun/bin/bun run dev --port 3001

# Run E2E tests
cd web && ~/.bun/bin/bunx playwright test

# Check logs
tail -50 /tmp/panoptikon.log
```
